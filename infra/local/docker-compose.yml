# Default logging uses json-file (built-in, no plugin required).
# To enable Loki push logging, install the Docker Loki plugin first:
#   docker plugin install grafana/loki-docker-driver:latest --alias loki --grant-all-permissions
# Then replace the block below with:
#   x-logging: &default-logging
#     driver: loki
#     options:
#       loki-url: "http://localhost:3100/loki/api/v1/push"
#       loki-retries: "2"
#       loki-max-backoff: "800ms"
#       loki-timeout: "1s"
x-logging: &default-logging
  driver: json-file
  options:
    max-size: "10m"
    max-file: "3"

services:
  postgres:
    image: postgres:15
    command: ["postgres", "-c", "wal_level=logical"]
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: arc_db
    ports:
      - "5432:5432"
    volumes:
      - ./postgres_init:/docker-entrypoint-initdb.d

  redis:
    image: redis:7
    ports:
      - "6379:6379"

  nats:
    image: nats:latest
    # JetStream enabled via CLI flags — avoids the nats.conf bind-mount directory issue.
    command: ["-js", "--store_dir=/data/nats", "-m", "8222"]
    ports:
      - "4222:4222"
      - "8222:8222"
    volumes:
      - nats_data:/data/nats

  keycloak:
    build:
      context: ./keycloak
      dockerfile: Dockerfile
    command: start-dev --import-realm
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      # Webhook Event Listener SPI configuration
      KC_SPI_EVENTS_LISTENER_HTTP_SERVER_URI: http://iam-service:8080/webhooks/keycloak
      KC_SPI_EVENTS_LISTENER_HTTP_SHARED_SECRET: dev-psk-change-me
    ports:
      - "8080:8080"
    volumes:
      - ./keycloak_realm/arc-realm.json:/opt/keycloak/data/import/arc-realm.json
    depends_on:
      - iam-service

  vault:
    image: hashicorp/vault:latest
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: "root"
      VAULT_DEV_LISTEN_ADDRESS: "0.0.0.0:8200"
    ports:
      - "8200:8200"
    cap_add:
      - IPC_LOCK

  # ── Observability Stack ──────────────────────────────────────────────
  jaeger:
    image: jaegertracing/all-in-one:latest
    environment:
      COLLECTOR_OTLP_ENABLED: "true"
    ports:
      - "16686:16686"
      - "4317:4317"
      - "4318:4318"

  prometheus:
    image: prom/prometheus:latest
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    depends_on:
      - jaeger

  grafana:
    image: grafana/grafana:latest
    environment:
      GF_AUTH_ANONYMOUS_ENABLED: "true"
      GF_AUTH_ANONYMOUS_ORG_ROLE: Admin
      GF_SECURITY_ADMIN_PASSWORD: admin
    ports:
      - "3001:3000"
    depends_on:
      - prometheus
      - loki

  loki:
    image: grafana/loki:latest
    ports:
      - "3100:3100"
    volumes:
      - ./loki-config.yaml:/etc/loki/local-config.yaml
    command: -config.file=/etc/loki/local-config.yaml

  # ── Go services: mount entire monorepo so go.work resolves local modules ──
  iam-service:
    image: golang:1.26
    environment:
      VAULT_ADDR: http://vault:8200
      VAULT_TOKEN: root
      VAULT_SECRET_PATH: secret/data/arc/iam-service
      OTEL_EXPORTER_OTLP_ENDPOINT: jaeger:4317
    volumes:
      - ../../:/workspace
    working_dir: /workspace/apps/iam-service
    command: ["go", "run", "./cmd/api"]
    depends_on:
      - postgres
      - nats
      - vault
      - jaeger
    logging: *default-logging

  audit-service:
    image: golang:1.26
    environment:
      VAULT_ADDR: http://vault:8200
      VAULT_TOKEN: root
      VAULT_SECRET_PATH: secret/data/arc/audit-service
      OTEL_EXPORTER_OTLP_ENDPOINT: jaeger:4317
    volumes:
      - ../../:/workspace
    working_dir: /workspace/apps/audit-service
    command: ["go", "run", "./cmd/api"]
    depends_on:
      - postgres
      - nats
      - vault
      - jaeger
    logging: *default-logging

  discovery-service:
    image: golang:1.26
    environment:
      VAULT_ADDR: http://vault:8200
      VAULT_TOKEN: root
      VAULT_SECRET_PATH: secret/data/arc/discovery-service
      OTEL_EXPORTER_OTLP_ENDPOINT: jaeger:4317
    volumes:
      - ../../:/workspace
    working_dir: /workspace/apps/discovery-service
    command: ["go", "run", "./cmd/api"]
    depends_on:
      - postgres
      - nats
      - vault
      - jaeger
    logging: *default-logging

  trm-service:
    image: golang:1.26
    environment:
      VAULT_ADDR: http://vault:8200
      VAULT_TOKEN: root
      VAULT_SECRET_PATH: secret/data/arc/trm-service
      OTEL_EXPORTER_OTLP_ENDPOINT: jaeger:4317
    volumes:
      - ../../:/workspace
    working_dir: /workspace/apps/trm-service
    command: ["go", "run", "./cmd/api"]
    depends_on:
      - postgres
      - nats
      - vault
      - jaeger
    logging: *default-logging

  cdc-worker:
    image: golang:1.26
    environment:
      VAULT_ADDR: http://vault:8200
      VAULT_TOKEN: root
      VAULT_SECRET_PATH: secret/data/arc/cdc-worker
      OTEL_EXPORTER_OTLP_ENDPOINT: jaeger:4317
    volumes:
      - ../../:/workspace
    working_dir: /workspace/apps/cdc-worker
    command: ["go", "run", "./cmd/worker"]
    depends_on:
      - postgres
      - nats
      - vault
      - jaeger
    logging: *default-logging

  public-api-service:
    image: golang:1.26
    environment:
      VAULT_ADDR: http://vault:8200
      VAULT_TOKEN: root
      VAULT_SECRET_PATH: secret/data/arc/public-api-service
      OTEL_EXPORTER_OTLP_ENDPOINT: jaeger:4317
    ports:
      - "8087:8080"
    volumes:
      - ../../:/workspace
    working_dir: /workspace/apps/public-api-service
    command: ["go", "run", "./cmd/api"]
    depends_on:
      - redis
      - nats
      - vault
      - jaeger
    logging: *default-logging

  notification-service:
    image: golang:1.26
    environment:
      VAULT_ADDR: http://vault:8200
      VAULT_TOKEN: root
      VAULT_SECRET_PATH: secret/data/arc/notification-service
      OTEL_EXPORTER_OTLP_ENDPOINT: jaeger:4317
    ports:
      - "8088:8080"
    volumes:
      - ../../:/workspace
    working_dir: /workspace/apps/notification-service
    command: ["go", "run", "./cmd/api"]
    depends_on:
      - postgres
      - nats
      - vault
      - jaeger
    logging: *default-logging

  apisix-go-runner:
    image: golang:1.26
    environment:
      APISIX_LISTEN_ADDRESS: unix:/tmp/runner.sock
      REDIS_URL: redis:6379
      IAM_GRPC_ADDR: iam-service:50051
      JWKS_URL: http://keycloak:8080/realms/arc/protocol/openid-connect/certs
      OTEL_EXPORTER_OTLP_ENDPOINT: jaeger:4317
    volumes:
      - runner-sock:/tmp
      - ../../:/workspace
    working_dir: /workspace/packages/apisix-go-runner
    command: ["go", "run", "./cmd/go-runner", "run"]
    depends_on:
      - redis
      - iam-service
      - keycloak
    logging: *default-logging

  apisix:
    image: apache/apisix:latest
    depends_on:
      - apisix-go-runner
    ports:
      - "9080:9080"
      - "9443:9443"
    volumes:
      - ./apisix_conf/apisix.yaml:/usr/local/apisix/conf/apisix.yaml
      - ./apisix_conf/config.yaml:/usr/local/apisix/conf/config.yaml
      - runner-sock:/tmp
    logging: *default-logging

volumes:
  runner-sock:
  nats_data:
